Return-Path: <owner-linux-mm@kvack.org>
Received: from mail-ee0-f43.google.com (mail-ee0-f43.google.com [74.125.83.43])
	by kanga.kvack.org (Postfix) with ESMTP id 0E64D6B0062
	for <linux-mm@kvack.org>; Tue, 22 Apr 2014 15:30:47 -0400 (EDT)
Received: by mail-ee0-f43.google.com with SMTP id e53so55696eek.16
        for <linux-mm@kvack.org>; Tue, 22 Apr 2014 12:30:47 -0700 (PDT)
Received: from mail-ee0-x22a.google.com (mail-ee0-x22a.google.com [2a00:1450:4013:c00::22a])
        by mx.google.com with ESMTPS id z42si61130347eel.92.2014.04.22.12.30.45
        for <linux-mm@kvack.org>
        (version=TLSv1 cipher=ECDHE-RSA-RC4-SHA bits=128/128);
        Tue, 22 Apr 2014 12:30:46 -0700 (PDT)
Received: by mail-ee0-f42.google.com with SMTP id d17so54491eek.29
        for <linux-mm@kvack.org>; Tue, 22 Apr 2014 12:30:45 -0700 (PDT)
Date: Tue, 22 Apr 2014 21:30:41 +0200
From: Daniel Vetter <daniel@ffwll.ch>
Subject: Re: [PATCH] mm: Throttle shrinkers harder
Message-ID: <20140422193041.GD10722@phenom.ffwll.local>
References: <1397113506-9177-1-git-send-email-chris@chris-wilson.co.uk>
 <20140418121416.c022eca055da1b6d81b2cf1b@linux-foundation.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20140418121416.c022eca055da1b6d81b2cf1b@linux-foundation.org>
Sender: owner-linux-mm@kvack.org
List-ID: <linux-mm.kvack.org>
To: Andrew Morton <akpm@linux-foundation.org>
Cc: Chris Wilson <chris@chris-wilson.co.uk>, linux-mm@kvack.org, intel-gfx@lists.freedesktop.org, Mel Gorman <mgorman@suse.de>, Michal Hocko <mhocko@suse.cz>, Rik van Riel <riel@redhat.com>, Johannes Weiner <hannes@cmpxchg.org>, Dave Chinner <dchinner@redhat.com>, Glauber Costa <glommer@openvz.org>, Hugh Dickins <hughd@google.com>, David Rientjes <rientjes@google.com>

On Fri, Apr 18, 2014 at 12:14:16PM -0700, Andrew Morton wrote:
> On Thu, 10 Apr 2014 08:05:06 +0100 Chris Wilson <chris@chris-wilson.co.uk> wrote:
> 
> > During testing of i915.ko with working texture sets larger than RAM, we
> > encounter OOM with plenty of memory still trapped within writeback, e.g:
> > 
> > [   42.386039] active_anon:10134 inactive_anon:1900781 isolated_anon:32
> >  active_file:33 inactive_file:39 isolated_file:0
> >  unevictable:0 dirty:0 writeback:337627 unstable:0
> >  free:11985 slab_reclaimable:9458 slab_unreclaimable:23614
> >  mapped:41 shmem:1560769 pagetables:1276 bounce:0
> > 
> > If we throttle for writeback following shrink_slab, this gives us time
> > to wait upon the writeback generated by the i915.ko shinker:
> > 
> > [ 4756.750808] active_anon:24386 inactive_anon:900793 isolated_anon:0
> >  active_file:23 inactive_file:20 isolated_file:0
> >  unevictable:0 dirty:0 writeback:0 unstable:0
> >  free:5550 slab_reclaimable:5184 slab_unreclaimable:4888
> >  mapped:3 shmem:472393 pagetables:1249 bounce:0
> > 
> > (Sadly though the test is still failing.)
> > 
> > Testcase: igt/gem_tiled_swapping
> > References: https://bugs.freedesktop.org/show_bug.cgi?id=72742
> 
> i915_gem_object_get_pages_gtt() makes my head spin, but
> https://bugs.freedesktop.org/attachment.cgi?id=90818 says
> "gfp_mask=0x201da" which is 
> 
> ___GFP_HARDWALL|___GFP_COLD|___GFP_FS|___GFP_IO|___GFP_WAIT|___GFP_MOVABLE|___GFP_HIGHMEM
> 
> so this allocation should work and it very bad if the page allocator is
> declaring oom while there is so much writeback in flight, assuming the
> writeback is to eligible zones.

For more head spinning look at the lock stealing dance we do in our
shrinker callbacks i915_gem_inactive_scan|count(). It's not pretty at all,
but it helps to avoids the dreaded oom in a few more cases. Some review of
our mess of ducttape from -mm developers with actual clue would be really
appreciated ...
-Daniel
 
> Mel, Johannes: could you take a look please?
> 
> --
> To unsubscribe, send a message with 'unsubscribe linux-mm' in
> the body to majordomo@kvack.org.  For more info on Linux MM,
> see: http://www.linux-mm.org/ .
> Don't email: <a href=mailto:"dont@kvack.org"> email@kvack.org </a>

-- 
Daniel Vetter
Software Engineer, Intel Corporation
+41 (0) 79 365 57 48 - http://blog.ffwll.ch

--
To unsubscribe, send a message with 'unsubscribe linux-mm' in
the body to majordomo@kvack.org.  For more info on Linux MM,
see: http://www.linux-mm.org/ .
Don't email: <a href=mailto:"dont@kvack.org"> email@kvack.org </a>
