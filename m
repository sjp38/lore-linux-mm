Return-Path: <owner-linux-mm@kvack.org>
Received: from mail-wr1-f72.google.com (mail-wr1-f72.google.com [209.85.221.72])
	by kanga.kvack.org (Postfix) with ESMTP id 69C9D8E0047
	for <linux-mm@kvack.org>; Wed, 23 Jan 2019 17:32:05 -0500 (EST)
Received: by mail-wr1-f72.google.com with SMTP id w16so1631522wrk.10
        for <linux-mm@kvack.org>; Wed, 23 Jan 2019 14:32:05 -0800 (PST)
Received: from EUR03-VE1-obe.outbound.protection.outlook.com (mail-eopbgr50075.outbound.protection.outlook.com. [40.107.5.75])
        by mx.google.com with ESMTPS id t131si38887583wmd.172.2019.01.23.14.32.03
        for <linux-mm@kvack.org>
        (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
        Wed, 23 Jan 2019 14:32:03 -0800 (PST)
From: Jason Gunthorpe <jgg@mellanox.com>
Subject: Re: [PATCH v4 9/9] RDMA/umem_odp: optimize out the case when a range
 is updated to read only
Date: Wed, 23 Jan 2019 22:32:00 +0000
Message-ID: <20190123223153.GP8986@mellanox.com>
References: <20190123222315.1122-1-jglisse@redhat.com>
 <20190123222315.1122-10-jglisse@redhat.com>
In-Reply-To: <20190123222315.1122-10-jglisse@redhat.com>
Content-Language: en-US
Content-Type: text/plain; charset="utf-8"
Content-ID: <19C285F8CDFF0C43B3E8C91122C9998E@eurprd05.prod.outlook.com>
Content-Transfer-Encoding: base64
MIME-Version: 1.0
Sender: owner-linux-mm@kvack.org
List-ID: <linux-mm.kvack.org>
To: "jglisse@redhat.com" <jglisse@redhat.com>
Cc: "linux-mm@kvack.org" <linux-mm@kvack.org>, Andrew Morton <akpm@linux-foundation.org>, "linux-kernel@vger.kernel.org" <linux-kernel@vger.kernel.org>, =?utf-8?B?Q2hyaXN0aWFuIEvDtm5pZw==?= <christian.koenig@amd.com>, Jan Kara <jack@suse.cz>, Felix Kuehling <Felix.Kuehling@amd.com>, Matthew Wilcox <mawilcox@microsoft.com>, Ross Zwisler <zwisler@kernel.org>, Dan Williams <dan.j.williams@intel.com>, Paolo Bonzini <pbonzini@redhat.com>, =?utf-8?B?UmFkaW0gS3LEjW3DocWZ?= <rkrcmar@redhat.com>, Michal Hocko <mhocko@kernel.org>, Ralph Campbell <rcampbell@nvidia.com>, John Hubbard <jhubbard@nvidia.com>, "kvm@vger.kernel.org" <kvm@vger.kernel.org>, "dri-devel@lists.freedesktop.org" <dri-devel@lists.freedesktop.org>, "linux-rdma@vger.kernel.org" <linux-rdma@vger.kernel.org>, "linux-fsdevel@vger.kernel.org" <linux-fsdevel@vger.kernel.org>, Arnd Bergmann <arnd@arndb.de>

T24gV2VkLCBKYW4gMjMsIDIwMTkgYXQgMDU6MjM6MTVQTSAtMDUwMCwgamdsaXNzZUByZWRoYXQu
Y29tIHdyb3RlOg0KPiBGcm9tOiBKw6lyw7RtZSBHbGlzc2UgPGpnbGlzc2VAcmVkaGF0LmNvbT4N
Cj4gDQo+IFdoZW4gcmFuZ2Ugb2YgdmlydHVhbCBhZGRyZXNzIGlzIHVwZGF0ZWQgcmVhZCBvbmx5
IGFuZCBjb3JyZXNwb25kaW5nDQo+IHVzZXIgcHRyIG9iamVjdCBhcmUgYWxyZWFkeSByZWFkIG9u
bHkgaXQgaXMgcG9pbnRsZXNzIHRvIGRvIGFueXRoaW5nLg0KPiBPcHRpbWl6ZSB0aGlzIGNhc2Ug
b3V0Lg0KPiANCj4gU2lnbmVkLW9mZi1ieTogSsOpcsO0bWUgR2xpc3NlIDxqZ2xpc3NlQHJlZGhh
dC5jb20+DQo+IENjOiBDaHJpc3RpYW4gS8O2bmlnIDxjaHJpc3RpYW4ua29lbmlnQGFtZC5jb20+
DQo+IENjOiBKYW4gS2FyYSA8amFja0BzdXNlLmN6Pg0KPiBDYzogRmVsaXggS3VlaGxpbmcgPEZl
bGl4Lkt1ZWhsaW5nQGFtZC5jb20+DQo+IENjOiBKYXNvbiBHdW50aG9ycGUgPGpnZ0BtZWxsYW5v
eC5jb20+DQo+IENjOiBBbmRyZXcgTW9ydG9uIDxha3BtQGxpbnV4LWZvdW5kYXRpb24ub3JnPg0K
PiBDYzogTWF0dGhldyBXaWxjb3ggPG1hd2lsY294QG1pY3Jvc29mdC5jb20+DQo+IENjOiBSb3Nz
IFp3aXNsZXIgPHp3aXNsZXJAa2VybmVsLm9yZz4NCj4gQ2M6IERhbiBXaWxsaWFtcyA8ZGFuLmou
d2lsbGlhbXNAaW50ZWwuY29tPg0KPiBDYzogUGFvbG8gQm9uemluaSA8cGJvbnppbmlAcmVkaGF0
LmNvbT4NCj4gQ2M6IFJhZGltIEtyxI1tw6HFmSA8cmtyY21hckByZWRoYXQuY29tPg0KPiBDYzog
TWljaGFsIEhvY2tvIDxtaG9ja29Aa2VybmVsLm9yZz4NCj4gQ2M6IFJhbHBoIENhbXBiZWxsIDxy
Y2FtcGJlbGxAbnZpZGlhLmNvbT4NCj4gQ2M6IEpvaG4gSHViYmFyZCA8amh1YmJhcmRAbnZpZGlh
LmNvbT4NCj4gQ2M6IGt2bUB2Z2VyLmtlcm5lbC5vcmcNCj4gQ2M6IGRyaS1kZXZlbEBsaXN0cy5m
cmVlZGVza3RvcC5vcmcNCj4gQ2M6IGxpbnV4LXJkbWFAdmdlci5rZXJuZWwub3JnDQo+IENjOiBs
aW51eC1mc2RldmVsQHZnZXIua2VybmVsLm9yZw0KPiBDYzogQXJuZCBCZXJnbWFubiA8YXJuZEBh
cm5kYi5kZT4NCj4gIGRyaXZlcnMvaW5maW5pYmFuZC9jb3JlL3VtZW1fb2RwLmMgfCAyMiArKysr
KysrKysrKysrKysrKysrLS0tDQo+ICBpbmNsdWRlL3JkbWEvaWJfdW1lbV9vZHAuaCAgICAgICAg
IHwgIDEgKw0KPiAgMiBmaWxlcyBjaGFuZ2VkLCAyMCBpbnNlcnRpb25zKCspLCAzIGRlbGV0aW9u
cygtKQ0KPiANCj4gZGlmZiAtLWdpdCBhL2RyaXZlcnMvaW5maW5pYmFuZC9jb3JlL3VtZW1fb2Rw
LmMgYi9kcml2ZXJzL2luZmluaWJhbmQvY29yZS91bWVtX29kcC5jDQo+IGluZGV4IGE0ZWM0MzA5
M2NiMy4uZmE0ZTdmZGNhYmZjIDEwMDY0NA0KPiArKysgYi9kcml2ZXJzL2luZmluaWJhbmQvY29y
ZS91bWVtX29kcC5jDQo+IEBAIC0xNDAsOCArMTQwLDE1IEBAIHN0YXRpYyB2b2lkIGliX3VtZW1f
bm90aWZpZXJfcmVsZWFzZShzdHJ1Y3QgbW11X25vdGlmaWVyICptbiwNCj4gIHN0YXRpYyBpbnQg
aW52YWxpZGF0ZV9yYW5nZV9zdGFydF90cmFtcG9saW5lKHN0cnVjdCBpYl91bWVtX29kcCAqaXRl
bSwNCj4gIAkJCQkJICAgICB1NjQgc3RhcnQsIHU2NCBlbmQsIHZvaWQgKmNvb2tpZSkNCj4gIHsN
Cj4gKwlib29sIHVwZGF0ZV90b19yZWFkX29ubHkgPSAqKChib29sICopY29va2llKTsNCj4gKw0K
PiAgCWliX3VtZW1fbm90aWZpZXJfc3RhcnRfYWNjb3VudChpdGVtKTsNCj4gLQlpdGVtLT51bWVt
LmNvbnRleHQtPmludmFsaWRhdGVfcmFuZ2UoaXRlbSwgc3RhcnQsIGVuZCk7DQo+ICsJLyoNCj4g
KwkgKiBJZiBpdCBpcyBhbHJlYWR5IHJlYWQgb25seSBhbmQgd2UgYXJlIHVwZGF0aW5nIHRvIHJl
YWQgb25seSB0aGVuIHdlDQo+ICsJICogZG8gbm90IG5lZWQgdG8gY2hhbmdlIGFueXRoaW5nLiBT
byBzYXZlIHRpbWUgYW5kIHNraXAgdGhpcyBvbmUuDQo+ICsJICovDQo+ICsJaWYgKCF1cGRhdGVf
dG9fcmVhZF9vbmx5IHx8ICFpdGVtLT5yZWFkX29ubHkpDQo+ICsJCWl0ZW0tPnVtZW0uY29udGV4
dC0+aW52YWxpZGF0ZV9yYW5nZShpdGVtLCBzdGFydCwgZW5kKTsNCj4gIAlyZXR1cm4gMDsNCj4g
IH0NCj4gIA0KPiBAQCAtMTUwLDYgKzE1Nyw3IEBAIHN0YXRpYyBpbnQgaWJfdW1lbV9ub3RpZmll
cl9pbnZhbGlkYXRlX3JhbmdlX3N0YXJ0KHN0cnVjdCBtbXVfbm90aWZpZXIgKm1uLA0KPiAgew0K
PiAgCXN0cnVjdCBpYl91Y29udGV4dF9wZXJfbW0gKnBlcl9tbSA9DQo+ICAJCWNvbnRhaW5lcl9v
Zihtbiwgc3RydWN0IGliX3Vjb250ZXh0X3Blcl9tbSwgbW4pOw0KPiArCWJvb2wgdXBkYXRlX3Rv
X3JlYWRfb25seTsNCj4gIA0KPiAgCWlmIChyYW5nZS0+YmxvY2thYmxlKQ0KPiAgCQlkb3duX3Jl
YWQoJnBlcl9tbS0+dW1lbV9yd3NlbSk7DQo+IEBAIC0xNjYsMTAgKzE3NCwxMyBAQCBzdGF0aWMg
aW50IGliX3VtZW1fbm90aWZpZXJfaW52YWxpZGF0ZV9yYW5nZV9zdGFydChzdHJ1Y3QgbW11X25v
dGlmaWVyICptbiwNCj4gIAkJcmV0dXJuIDA7DQo+ICAJfQ0KPiAgDQo+ICsJdXBkYXRlX3RvX3Jl
YWRfb25seSA9IG1tdV9ub3RpZmllcl9yYW5nZV91cGRhdGVfdG9fcmVhZF9vbmx5KHJhbmdlKTsN
Cj4gKw0KPiAgCXJldHVybiByYnRfaWJfdW1lbV9mb3JfZWFjaF9pbl9yYW5nZSgmcGVyX21tLT51
bWVtX3RyZWUsIHJhbmdlLT5zdGFydCwNCj4gIAkJCQkJICAgICByYW5nZS0+ZW5kLA0KPiAgCQkJ
CQkgICAgIGludmFsaWRhdGVfcmFuZ2Vfc3RhcnRfdHJhbXBvbGluZSwNCj4gLQkJCQkJICAgICBy
YW5nZS0+YmxvY2thYmxlLCBOVUxMKTsNCj4gKwkJCQkJICAgICByYW5nZS0+YmxvY2thYmxlLA0K
PiArCQkJCQkgICAgICZ1cGRhdGVfdG9fcmVhZF9vbmx5KTsNCj4gIH0NCj4gIA0KPiAgc3RhdGlj
IGludCBpbnZhbGlkYXRlX3JhbmdlX2VuZF90cmFtcG9saW5lKHN0cnVjdCBpYl91bWVtX29kcCAq
aXRlbSwgdTY0IHN0YXJ0LA0KPiBAQCAtMzYzLDYgKzM3NCw5IEBAIHN0cnVjdCBpYl91bWVtX29k
cCAqaWJfYWxsb2Nfb2RwX3VtZW0oc3RydWN0IGliX3Vjb250ZXh0X3Blcl9tbSAqcGVyX21tLA0K
PiAgCQlnb3RvIG91dF9vZHBfZGF0YTsNCj4gIAl9DQo+ICANCj4gKwkvKiBBc3N1bWUgcmVhZCBv
bmx5IGF0IGZpcnN0LCBlYWNoIHRpbWUgR1VQIGlzIGNhbGwgdGhpcyBpcyB1cGRhdGVkLiAqLw0K
PiArCW9kcF9kYXRhLT5yZWFkX29ubHkgPSB0cnVlOw0KPiArDQo+ICAJb2RwX2RhdGEtPmRtYV9s
aXN0ID0NCj4gIAkJdnphbGxvYyhhcnJheV9zaXplKHBhZ2VzLCBzaXplb2YoKm9kcF9kYXRhLT5k
bWFfbGlzdCkpKTsNCj4gIAlpZiAoIW9kcF9kYXRhLT5kbWFfbGlzdCkgew0KPiBAQCAtNjE5LDgg
KzYzMywxMCBAQCBpbnQgaWJfdW1lbV9vZHBfbWFwX2RtYV9wYWdlcyhzdHJ1Y3QgaWJfdW1lbV9v
ZHAgKnVtZW1fb2RwLCB1NjQgdXNlcl92aXJ0LA0KPiAgCQlnb3RvIG91dF9wdXRfdGFzazsNCj4g
IAl9DQo+ICANCj4gLQlpZiAoYWNjZXNzX21hc2sgJiBPRFBfV1JJVEVfQUxMT1dFRF9CSVQpDQo+
ICsJaWYgKGFjY2Vzc19tYXNrICYgT0RQX1dSSVRFX0FMTE9XRURfQklUKSB7DQo+ICsJCXVtZW1f
b2RwLT5yZWFkX29ubHkgPSBmYWxzZTsNCg0KTm8gbG9ja2luZz8NCg0KPiAgCQlmbGFncyB8PSBG
T0xMX1dSSVRFOw0KPiArCX0NCj4gIA0KPiAgCXN0YXJ0X2lkeCA9ICh1c2VyX3ZpcnQgLSBpYl91
bWVtX3N0YXJ0KHVtZW0pKSA+PiBwYWdlX3NoaWZ0Ow0KPiAgCWsgPSBzdGFydF9pZHg7DQo+IGRp
ZmYgLS1naXQgYS9pbmNsdWRlL3JkbWEvaWJfdW1lbV9vZHAuaCBiL2luY2x1ZGUvcmRtYS9pYl91
bWVtX29kcC5oDQo+IGluZGV4IDBiMTQ0NmZlMmZhYi4uODI1NjY2OGM2MTcwIDEwMDY0NA0KPiAr
KysgYi9pbmNsdWRlL3JkbWEvaWJfdW1lbV9vZHAuaA0KPiBAQCAtNzYsNiArNzYsNyBAQCBzdHJ1
Y3QgaWJfdW1lbV9vZHAgew0KPiAgCXN0cnVjdCBjb21wbGV0aW9uCW5vdGlmaWVyX2NvbXBsZXRp
b247DQo+ICAJaW50CQkJZHlpbmc7DQo+ICAJc3RydWN0IHdvcmtfc3RydWN0CXdvcms7DQo+ICsJ
Ym9vbCByZWFkX29ubHk7DQo+ICB9Ow0KDQpUaGUgaWJfdW1lbSBhbHJlYWR5IGhhcyBhIHdyaXRl
YWJsZSBmbGFnLiBUaGlzIHJlZmxlY3RzIGlmIHRoZSB1c2VyDQphc2tlZCBmb3Igd3JpdGUgcGVy
bWlzc2lvbiB0byBiZSBncmFudGVkLi4gVGhlIHRyYWNraW5nIGhlcmUgaXMgaWYgYW55DQpyZW1v
dGUgZmF1bHQgdGh1cyBmYXIgaGFzIHJlcXVlc3RlZCB3cml0ZSwgaXMgdGhpcyBhbiBpbXBvcnRh
bnQNCmRpZmZlcmVuY2UgdG8ganVzdGlmeSB0aGUgbmV3IGZsYWc/DQoNCkphc29uDQo=
