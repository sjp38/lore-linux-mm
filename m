Return-Path: <owner-linux-mm@kvack.org>
Received: from mail-pf0-f197.google.com (mail-pf0-f197.google.com [209.85.192.197])
	by kanga.kvack.org (Postfix) with ESMTP id E951B6B0033
	for <linux-mm@kvack.org>; Tue, 26 Dec 2017 22:13:32 -0500 (EST)
Received: by mail-pf0-f197.google.com with SMTP id e26so26549692pfi.15
        for <linux-mm@kvack.org>; Tue, 26 Dec 2017 19:13:32 -0800 (PST)
Received: from bombadil.infradead.org (bombadil.infradead.org. [65.50.211.133])
        by mx.google.com with ESMTPS id w70si24045936pfk.109.2017.12.26.19.13.31
        for <linux-mm@kvack.org>
        (version=TLS1_2 cipher=ECDHE-RSA-CHACHA20-POLY1305 bits=256/256);
        Tue, 26 Dec 2017 19:13:31 -0800 (PST)
Date: Tue, 26 Dec 2017 19:13:26 -0800
From: Matthew Wilcox <willy@infradead.org>
Subject: Re: [PATCH v5 06/78] xarray: Change definition of sibling entries
Message-ID: <20171227031326.GB24828@bombadil.infradead.org>
References: <20171215220450.7899-1-willy@infradead.org>
 <20171215220450.7899-7-willy@infradead.org>
 <20171226172153.pylgdefajcrthe3b@node.shutemov.name>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20171226172153.pylgdefajcrthe3b@node.shutemov.name>
Sender: owner-linux-mm@kvack.org
List-ID: <linux-mm.kvack.org>
To: "Kirill A. Shutemov" <kirill@shutemov.name>
Cc: linux-kernel@vger.kernel.org, Matthew Wilcox <mawilcox@microsoft.com>, Ross Zwisler <ross.zwisler@linux.intel.com>, David Howells <dhowells@redhat.com>, Shaohua Li <shli@kernel.org>, Jens Axboe <axboe@kernel.dk>, Rehas Sachdeva <aquannie@gmail.com>, Marc Zyngier <marc.zyngier@arm.com>, linux-mm@kvack.org, linux-fsdevel@vger.kernel.org, linux-f2fs-devel@lists.sourceforge.net, linux-nilfs@vger.kernel.org, linux-btrfs@vger.kernel.org, linux-xfs@vger.kernel.org, linux-usb@vger.kernel.org, linux-raid@vger.kernel.org

On Tue, Dec 26, 2017 at 08:21:53PM +0300, Kirill A. Shutemov wrote:
> > +/**
> > + * xa_is_internal() - Is the entry an internal entry?
> > + * @entry: Entry retrieved from the XArray
> > + *
> > + * Return: %true if the entry is an internal entry.
> > + */
> 
> What does it mean "internal entry"? Is it just a term for non-value and
> non-data pointer entry? Do we allow anybody besides xarray implementation to
> use internal entires?
> 
> Do we have it documented?

We do!  include/linux/radix-tree.h has it documented right now:

/*
 * The bottom two bits of the slot determine how the remaining bits in the
 * slot are interpreted:
 *
 * 00 - data pointer
 * 01 - internal entry
 * 10 - exceptional entry
 * 11 - this bit combination is currently unused/reserved

Slightly further down this same patch you're commenting on, this comment
is added:

+/*
+ * Internal entries have the bottom two bits set to the value 10b.  Most
+ * internal entries are pointers to the next node in the tree.  Since the
+ * kernel unmaps page 0 to trap NULL pointer dereferences, we can use values
+ * 0-1023 for special purposes.  Values 0-62 are used for sibling
+ * entries.  Value 256 is used for the retry entry.
+ */

That comment is later changed to:

/*
 * Internal entries have the bottom two bits set to the value 10b.  Most
 * internal entries are pointers to the next node in the tree.  Since the
 * kernel unmaps page 0 to trap NULL pointer dereferences, we can use values
 * 0-1023 for special purposes.  Values 0-62 are used for sibling
 * entries.  Value 256 is used for zero entries.  Value 257 is used for the
 * retry entry.
 *
 * Errors are also represented as internal entries, but use the negative
 * space (-4094 to -2).  They're never stored in the slots array; only
 * generated by the normal API.
 */

Also, this section exists in the documentation patch:

+Internal Entries
+----------------
+
+The XArray reserves some entries for its own purposes.  These are never
+exposed through the normal API, but when using the advanced API, it's
+possible to see them.  Usually the best way to handle them is to pass them
+to :c:func:`xas_retry`, and retry the operation if it returns ``true``.

[...]

--
To unsubscribe, send a message with 'unsubscribe linux-mm' in
the body to majordomo@kvack.org.  For more info on Linux MM,
see: http://www.linux-mm.org/ .
Don't email: <a href=mailto:"dont@kvack.org"> email@kvack.org </a>
