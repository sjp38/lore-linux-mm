Return-Path: <owner-linux-mm@kvack.org>
Received: from psmtp.com (na3sys010amx168.postini.com [74.125.245.168])
	by kanga.kvack.org (Postfix) with SMTP id 98B796B0032
	for <linux-mm@kvack.org>; Fri,  7 Jun 2013 09:50:19 -0400 (EDT)
Received: by mail-pd0-f182.google.com with SMTP id g10so4810453pdj.41
        for <linux-mm@kvack.org>; Fri, 07 Jun 2013 06:50:18 -0700 (PDT)
Date: Fri, 07 Jun 2013 22:50:09 +0900
Message-ID: <87txlado8e.wl%mitake.hitoshi@gmail.com>
From: Hitoshi Mitake <mitake.hitoshi@gmail.com>
Subject: Re: Transparent Hugepage impact on memcpy
In-Reply-To: <51B136E2.4010606@huawei.com>
References: <51ADAC15.1050103@huawei.com>
	<51AEAFD8.305@huawei.com>
	<CAMO-S2ixv55bGEFGR6Eh=UZgVBz=nv81EckuzWoVi0t4KdB+VA@mail.gmail.com>
	<51B136E2.4010606@huawei.com>
MIME-Version: 1.0 (generated by SEMI 1.14.6 - "Maruoka")
Content-Type: text/plain; charset=US-ASCII
Sender: owner-linux-mm@kvack.org
List-ID: <linux-mm.kvack.org>
To: Jianguo Wu <wujianguo@huawei.com>
Cc: Hitoshi Mitake <mitake@dcl.info.waseda.ac.jp>, linux-mm@kvack.org, Andrea Arcangeli <aarcange@redhat.com>, qiuxishi <qiuxishi@huawei.com>, Wanpeng Li <liwanp@linux.vnet.ibm.com>, Hush Bensen <hush.bensen@gmail.com>, mitake.hitoshi@gmail.com

At Fri, 7 Jun 2013 09:26:58 +0800,
Jianguo Wu wrote:
> 
> Hi Hitoshi,
> 
> Thanks for your reply! please see below.
> 
> On 2013/6/6 21:54, Hitoshi Mitake wrote:
> 
> > Hi Jianguo,
> > 
> > On Wed, Jun 5, 2013 at 12:26 PM, Jianguo Wu <wujianguo@huawei.com> wrote:
> >> Hi,
> >> One more question, I wrote a memcpy test program, mostly the same as with perf bench memcpy.
> >> But test result isn't consistent with perf bench when THP is off.
> >>
> >>         my program                              perf bench
> >> THP:    3.628368 GB/Sec (with prefault)         3.672879 GB/Sec (with prefault)
> >> NO-THP: 3.612743 GB/Sec (with prefault)         6.190187 GB/Sec (with prefault)
> >>
> >> Below is my code:
> >>         src = calloc(1, len);
> >>         dst = calloc(1, len);
> >>
> >>         if (prefault)
> >>                 memcpy(dst, src, len);
> >>         gettimeofday(&tv_start, NULL);
> >>         memcpy(dst, src, len);
> >>         gettimeofday(&tv_end, NULL);
> >>
> >>         timersub(&tv_end, &tv_start, &tv_diff);
> >>         free(src);
> >>         free(dst);
> >>
> >>         speed = (double)((double)len / timeval2double(&tv_diff));
> >>         print_bps(speed);
> >>
> >> This is weird, is it possible that perf bench do some build optimize?
> >>
> >> Thansk,
> >> Jianguo Wu.
> > 
> > perf bench mem memcpy is build with -O6. This is the compile command
> > line (you can get this with make V=1):
> > gcc -o bench/mem-memcpy-x86-64-asm.o -c -fno-omit-frame-pointer -ggdb3
> > -funwind-tables -Wall -Wextra -std=gnu99 -Werror -O6 .... # ommited
> > 
> > Can I see your compile option for your test program and the actual
> > command line executing perf bench mem memcpy?
> > 
> 
> I just compiled my test program with gcc -o memcpy-test memcpy-test.c.
> I tried to use the same compile option with perf bench mem memcpy, and
> the test result showed no difference.
> 
> My execute command line for perf bench mem memcpy:
> #./perf bench mem memcpy -l 1gb -o

Thanks for your information. I have three more requests for
reproducing the problem:

1. the entire source code of your program
2. your gcc version
3. your glibc version

I should've requested it first, sorry :(

Thanks,
Hitoshi

--
To unsubscribe, send a message with 'unsubscribe linux-mm' in
the body to majordomo@kvack.org.  For more info on Linux MM,
see: http://www.linux-mm.org/ .
Don't email: <a href=mailto:"dont@kvack.org"> email@kvack.org </a>
