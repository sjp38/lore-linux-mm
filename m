Date: Fri, 12 May 2000 20:53:49 +0200 (CEST)
From: Ingo Molnar <mingo@elte.hu>
Reply-To: mingo@elte.hu
Subject: Re: [patch] balanced highmem subsystem under pre7-9
In-Reply-To: <Pine.LNX.4.10.10005121111340.4959-100000@penguin.transmeta.com>
Message-ID: <Pine.LNX.4.10.10005122044130.6188-200000@elte.hu>
MIME-Version: 1.0
Content-Type: MULTIPART/MIXED; BOUNDARY="79888902-1023949917-958157629=:6188"
Sender: owner-linux-mm@kvack.org
Return-Path: <owner-linux-mm@kvack.org>
To: Linus Torvalds <torvalds@transmeta.com>
Cc: Rik van Riel <riel@conectiva.com.br>, Andrea Arcangeli <andrea@suse.de>, MM mailing list <linux-mm@kvack.org>, linux-kernel@vger.rutgers.edu
List-ID: <linux-mm.kvack.org>

--79888902-1023949917-958157629=:6188
Content-Type: TEXT/PLAIN; charset=US-ASCII


On Fri, 12 May 2000, Linus Torvalds wrote:

> With such a setup, your patch makes lots of sense - trying to decouple
> the highmem zone as much as possible. But the more recent kernels
> should be better at not touching zones that don't need touching (it
> will still change the LRU information, though).

i initially tested pre7-9 and it showed bad behavior: high kswapd activity
trying to balance highmem, while the pagecache is primarily filled from
the highmem. I dont think this can be fixed without 'silencing'
ZONE_HIGHMEM's balancing activities: the pagecache allocates from highmem
so it puts direct pressure on the highmem zone.

This had two effects: wasted CPU time, but it also limited the
page-cache's maximum size to the size of highmem. I'll try the final
pre7-2.3.99 kernel as well in a minute to make sure. (i think the bad
behavior is still be there, judging from the differences between pre9 and
the final patch.)

(i've attached a patch against final-pre7, which is not complete and which
i'm not yet happy about (the kernel shows bad behavior if lots of dirty
data is generated by many processes), but it shows eg. the highmem.c
cleanup that is possible.)

	Ingo

--79888902-1023949917-958157629=:6188
Content-Type: TEXT/PLAIN; charset=US-ASCII; name="highmem-2.3.99-7-B1"
Content-Transfer-Encoding: BASE64
Content-ID: <Pine.LNX.4.10.10005122053490.6188@elte.hu>
Content-Description: 
Content-Disposition: attachment; filename="highmem-2.3.99-7-B1"

LS0tIGxpbnV4L21tL3BhZ2VfYWxsb2MuYy5vcmlnCUZyaSBNYXkgMTIgMDg6
NDU6MTcgMjAwMA0KKysrIGxpbnV4L21tL3BhZ2VfYWxsb2MuYwlGcmkgTWF5
IDEyIDA5OjE0OjU4IDIwMDANCkBAIC0yOSw5ICsyOSw5IEBADQogcGdfZGF0
YV90ICpwZ2RhdF9saXN0ID0gKHBnX2RhdGFfdCAqKTA7DQogDQogc3RhdGlj
IGNoYXIgKnpvbmVfbmFtZXNbTUFYX05SX1pPTkVTXSA9IHsgIkRNQSIsICJO
b3JtYWwiLCAiSGlnaE1lbSIgfTsNCi1zdGF0aWMgaW50IHpvbmVfYmFsYW5j
ZV9yYXRpb1tNQVhfTlJfWk9ORVNdID0geyAxMjgsIDEyOCwgMTI4LCB9Ow0K
LXN0YXRpYyBpbnQgem9uZV9iYWxhbmNlX21pbltNQVhfTlJfWk9ORVNdID0g
eyAxMCAsIDEwLCAxMCwgfTsNCi1zdGF0aWMgaW50IHpvbmVfYmFsYW5jZV9t
YXhbTUFYX05SX1pPTkVTXSA9IHsgMjU1ICwgMjU1LCAyNTUsIH07DQorc3Rh
dGljIGludCB6b25lX2JhbGFuY2VfcmF0aW9bTUFYX05SX1pPTkVTXSA9IHsg
MTI4LCAxMjgsIDEsIH07DQorc3RhdGljIGludCB6b25lX2JhbGFuY2VfbWlu
W01BWF9OUl9aT05FU10gPSB7IDEwICwgMTAsIDAsIH07DQorc3RhdGljIGlu
dCB6b25lX2JhbGFuY2VfbWF4W01BWF9OUl9aT05FU10gPSB7IDI1NSAsIDI1
NSwgMCwgfTsNCiANCiAvKg0KICAqIEZyZWVfcGFnZSgpIGFkZHMgdGhlIHBh
Z2UgdG8gdGhlIGZyZWUgbGlzdHMuIFRoaXMgaXMgb3B0aW1pemVkIGZvcg0K
QEAgLTI3MSw3ICsyNzEsMTAgQEANCiAJaWYgKCEoY3VycmVudC0+ZmxhZ3Mg
JiBQRl9NRU1BTExPQykpIHsNCiAJCWludCBnZnBfbWFzayA9IHpvbmVsaXN0
LT5nZnBfbWFzazsNCiAJCWlmICghdHJ5X3RvX2ZyZWVfcGFnZXMoZ2ZwX21h
c2spKSB7DQotCQkJaWYgKCEoZ2ZwX21hc2sgJiBfX0dGUF9ISUdIKSkNCisJ
CQkvKg0KKwkJCSAqIE5vbi1oaWdocHJpbyBhbGxvY2F0aW9ucyBmYWlsIGhl
cmU6DQorCQkJICovDQorCQkJaWYgKCEoZ2ZwX21hc2sgJiBfX0dGUF9QUklP
KSkNCiAJCQkJZ290byBmYWlsOw0KIAkJfQ0KIAl9DQpAQCAtNDQwLDYgKzQ0
Myw5IEBADQogCQkJCXpvbmUgPSBwZ2RhdC0+bm9kZV96b25lcyArIFpPTkVf
Tk9STUFMOw0KIAkJCQlpZiAoem9uZS0+c2l6ZSkNCiAJCQkJCXpvbmVsaXN0
LT56b25lc1tqKytdID0gem9uZTsNCisJCQkJaWYgKChpICYmIF9fR0ZQX1dB
SVQpIHx8ICEoaSAmJiBfX0dGUF9QUklPKSB8fA0KKwkJCQkJCShpICYmIF9f
R0ZQX0lPKSkNCisJCQkJCWJyZWFrOw0KIAkJCWNhc2UgWk9ORV9ETUE6DQog
CQkJCXpvbmUgPSBwZ2RhdC0+bm9kZV96b25lcyArIFpPTkVfRE1BOw0KIAkJ
CQlpZiAoem9uZS0+c2l6ZSkNCi0tLSBsaW51eC9tbS9oaWdobWVtLmMub3Jp
ZwlGcmkgTWF5IDEyIDA5OjE2OjI1IDIwMDANCisrKyBsaW51eC9tbS9oaWdo
bWVtLmMJRnJpIE1heSAxMiAwOToyNzoxNCAyMDAwDQpAQCAtNjYsNiArNjYs
MTMgQEANCiAJcmV0dXJuIG5ld19wYWdlOw0KIH0NCiANCisvKg0KKyAqIFNw
ZWNpYWwgem9uZWxpc3Qgc28gd2UgY2FuIGp1c3QgcXVlcnkgdGhlIGhpZ2ht
ZW0gcG9vbCBhbmQNCisgKiByZXR1cm4gaW1tZWRpYXRlbHkgaWYgdGhlcmUg
aXMgbm8gaGlnaG1lbSBwYWdlIGZyZWUuDQorICovDQorc3RhdGljIHpvbmVs
aXN0X3QgaGlnaF96b25lbGlzdCA9DQorCXsgeyBOT0RFX0RBVEEoMCktPm5v
ZGVfem9uZXMgKyBaT05FX0hJR0hNRU0sIE5VTEwsIH0sIF9fR0ZQX0hJR0hN
RU0gfTsNCisNCiBzdHJ1Y3QgcGFnZSAqIHJlcGxhY2Vfd2l0aF9oaWdobWVt
KHN0cnVjdCBwYWdlICogcGFnZSkNCiB7DQogCXN0cnVjdCBwYWdlICpoaWdo
cGFnZTsNCkBAIC03NCwxMyArODEsMTEgQEANCiAJaWYgKFBhZ2VIaWdoTWVt
KHBhZ2UpIHx8ICFucl9mcmVlX2hpZ2hwYWdlcygpKQ0KIAkJcmV0dXJuIHBh
Z2U7DQogDQotCWhpZ2hwYWdlID0gYWxsb2NfcGFnZShHRlBfQVRPTUlDfF9f
R0ZQX0hJR0hNRU0pOw0KKwloaWdocGFnZSA9IF9fYWxsb2NfcGFnZXMoJmhp
Z2hfem9uZWxpc3QsIDApOw0KIAlpZiAoIWhpZ2hwYWdlKQ0KIAkJcmV0dXJu
IHBhZ2U7DQotCWlmICghUGFnZUhpZ2hNZW0oaGlnaHBhZ2UpKSB7DQotCQlf
X2ZyZWVfcGFnZShoaWdocGFnZSk7DQotCQlyZXR1cm4gcGFnZTsNCi0JfQ0K
KwlpZiAoIVBhZ2VIaWdoTWVtKGhpZ2hwYWdlKSkNCisJCUJVRygpOw0KIA0K
IAl2YWRkciA9IGttYXAoaGlnaHBhZ2UpOw0KIAljb3B5X3BhZ2UoKHZvaWQg
Kil2YWRkciwgKHZvaWQgKilwYWdlX2FkZHJlc3MocGFnZSkpOw0KLS0tIGxp
bnV4L2luY2x1ZGUvbGludXgvbW0uaC5vcmlnCUZyaSBNYXkgMTIgMDg6NDY6
NTUgMjAwMA0KKysrIGxpbnV4L2luY2x1ZGUvbGludXgvbW0uaAlGcmkgTWF5
IDEyIDA5OjI3OjU2IDIwMDANCkBAIC00NzEsMzMgKzQ3MSw0OSBAQA0KICAq
IEdGUCBiaXRtYXNrcy4uDQogICovDQogI2RlZmluZSBfX0dGUF9XQUlUCTB4
MDENCi0jZGVmaW5lIF9fR0ZQX0hJR0gJMHgwMg0KKyNkZWZpbmUgX19HRlBf
UFJJTwkweDAyDQogI2RlZmluZSBfX0dGUF9JTwkweDA0DQorLyoNCisgKiBp
bmRpY2F0ZXMgdGhhdCB0aGUgYnVmZmVyIHdpbGwgYmUgc3VpdGFibGUgZm9y
IERNQS4gIElnbm9yZWQgb24gc29tZQ0KKyAqIHBsYXRmb3JtcywgdXNlZCBh
cyBhcHByb3ByaWF0ZSBvbiBvdGhlcnMNCisgKi8NCiAjZGVmaW5lIF9fR0ZQ
X0RNQQkweDA4DQorDQorLyoNCisgKiBpbmRpY2F0ZXMgdGhhdCB0aGUgYnVm
ZmVyIGNhbiBiZSB0YWtlbiBmcm9tIGhpZ2ggbWVtb3J5LA0KKyAqIHdoaWNo
IGlzIG5vdCBwZXJtYW5lbnRseSBtYXBwZWQgYnkgdGhlIGtlcm5lbA0KKyAq
Lw0KICNpZmRlZiBDT05GSUdfSElHSE1FTQ0KICNkZWZpbmUgX19HRlBfSElH
SE1FTQkweDEwDQogI2Vsc2UNCiAjZGVmaW5lIF9fR0ZQX0hJR0hNRU0JMHgw
IC8qIG5vb3AgKi8NCiAjZW5kaWYNCiANCi0NCi0jZGVmaW5lIEdGUF9CVUZG
RVIJKF9fR0ZQX0hJR0ggfCBfX0dGUF9XQUlUKQ0KLSNkZWZpbmUgR0ZQX0FU
T01JQwkoX19HRlBfSElHSCkNCi0jZGVmaW5lIEdGUF9VU0VSCShfX0dGUF9X
QUlUIHwgX19HRlBfSU8pDQotI2RlZmluZSBHRlBfSElHSFVTRVIJKEdGUF9V
U0VSIHwgX19HRlBfSElHSE1FTSkNCi0jZGVmaW5lIEdGUF9LRVJORUwJKF9f
R0ZQX0hJR0ggfCBfX0dGUF9XQUlUIHwgX19HRlBfSU8pDQotI2RlZmluZSBH
RlBfTkZTCQkoX19HRlBfSElHSCB8IF9fR0ZQX1dBSVQgfCBfX0dGUF9JTykN
Ci0jZGVmaW5lIEdGUF9LU1dBUEQJKF9fR0ZQX0lPKQ0KLQ0KLS8qIEZsYWcg
LSBpbmRpY2F0ZXMgdGhhdCB0aGUgYnVmZmVyIHdpbGwgYmUgc3VpdGFibGUg
Zm9yIERNQS4gIElnbm9yZWQgb24gc29tZQ0KLSAgIHBsYXRmb3JtcywgdXNl
ZCBhcyBhcHByb3ByaWF0ZSBvbiBvdGhlcnMgKi8NCi0NCi0jZGVmaW5lIEdG
UF9ETUEJCV9fR0ZQX0RNQQ0KLQ0KLS8qIEZsYWcgLSBpbmRpY2F0ZXMgdGhh
dCB0aGUgYnVmZmVyIGNhbiBiZSB0YWtlbiBmcm9tIGhpZ2ggbWVtb3J5IHdo
aWNoIGlzIG5vdA0KLSAgIHBlcm1hbmVudGx5IG1hcHBlZCBieSB0aGUga2Vy
bmVsICovDQotDQotI2RlZmluZSBHRlBfSElHSE1FTQlfX0dGUF9ISUdITUVN
DQorLyoNCisgKiBUaGUgNSBHRlAgYml0czoNCisgKgkoIF9fR0ZQX1dBSVQg
fCBfX0dGUF9QUklPIHwgX19HRlBfSU8gfCBfX0dGUF9ETUEgfCBfX0dGUF9I
SUdITUVNICkNCisgKg0KKyAqIFRoZSBtb3N0IHR5cGljYWwgY29tYmluYXRp
b25zOg0KKyAqLw0KKw0KKyNkZWZpbmUgR0ZQX0JVRkZFUiAgIFwNCisJKCBf
X0dGUF9XQUlUIHwgX19HRlBfUFJJTyB8IDAgICAgICAgIHwgMCAgICAgICAg
IHwgMCAgICAgICAgICAgICApDQorI2RlZmluZSBHRlBfQVRPTUlDICAgXA0K
KwkoIDAgICAgICAgICAgfCBfX0dGUF9QUklPIHwgMCAgICAgICAgfCAwICAg
ICAgICAgfCAwICAgICAgICAgICAgICkNCisjZGVmaW5lIEdGUF9VU0VSICAg
ICBcDQorCSggX19HRlBfV0FJVCB8IDAgICAgICAgICAgfCBfX0dGUF9JTyB8
IDAgICAgICAgICB8IDAgICAgICAgICAgICAgKQ0KKyNkZWZpbmUgR0ZQX0hJ
R0hVU0VSIFwNCisJKCBfX0dGUF9XQUlUIHwgMCAgICAgICAgICB8IF9fR0ZQ
X0lPIHwgMCAgICAgICAgIHwgX19HRlBfSElHSE1FTSApDQorI2RlZmluZSBH
RlBfS0VSTkVMICAgXA0KKwkoIF9fR0ZQX1dBSVQgfCBfX0dGUF9QUklPIHwg
X19HRlBfSU8gfCAwICAgICAgICAgfCAwICAgICAgICAgICAgICkNCisjZGVm
aW5lIEdGUF9ORlMgICAgICBcDQorCSggX19HRlBfV0FJVCB8IF9fR0ZQX1BS
SU8gfCBfX0dGUF9JTyB8IDAgICAgICAgICB8IDAgICAgICAgICAgICAgKQ0K
KyNkZWZpbmUgR0ZQX0tTV0FQRCAgIFwNCisJKCAwICAgICAgICAgIHwgMCAg
ICAgICAgICB8IF9fR0ZQX0lPIHwgMCAgICAgICAgIHwgMCAgICAgICAgICAg
ICApDQorI2RlZmluZSBHRlBfRE1BICAgICAgXA0KKwkoIDAgICAgICAgICAg
fCAwICAgICAgICAgIHwgMCAgICAgICAgfCBfX0dGUF9ETUEgfCAwICAgICAg
ICAgICAgICkNCisjZGVmaW5lIEdGUF9ISUdITUVNICBcDQorCSggMCAgICAg
ICAgICB8IDAgICAgICAgICAgfCAwICAgICAgICB8IDAgICAgICAgICB8IF9f
R0ZQX0hJR0hNRU0gKQ0KIA0KIC8qIHZtYSBpcyB0aGUgZmlyc3Qgb25lIHdp
dGggIGFkZHJlc3MgPCB2bWEtPnZtX2VuZCwNCiAgKiBhbmQgZXZlbiAgYWRk
cmVzcyA8IHZtYS0+dm1fc3RhcnQuIEhhdmUgdG8gZXh0ZW5kIHZtYS4gKi8N
Ci0tLSBsaW51eC9pbmNsdWRlL2xpbnV4L3NsYWIuaC5vcmlnCUZyaSBNYXkg
MTIgMDk6MDU6MTUgMjAwMA0KKysrIGxpbnV4L2luY2x1ZGUvbGludXgvc2xh
Yi5oCUZyaSBNYXkgMTIgMDk6Mjc6NTYgMjAwMA0KQEAgLTIyLDcgKzIyLDcg
QEANCiAjZGVmaW5lCVNMQUJfTkZTCQlHRlBfTkZTDQogI2RlZmluZQlTTEFC
X0RNQQkJR0ZQX0RNQQ0KIA0KLSNkZWZpbmUgU0xBQl9MRVZFTF9NQVNLCQko
X19HRlBfV0FJVHxfX0dGUF9ISUdIfF9fR0ZQX0lPfF9fR0ZQX0hJR0hNRU0p
DQorI2RlZmluZSBTTEFCX0xFVkVMX01BU0sJCShfX0dGUF9XQUlUfF9fR0ZQ
X1BSSU98X19HRlBfSU98X19HRlBfSElHSE1FTSkNCiAjZGVmaW5lCVNMQUJf
Tk9fR1JPVwkJMHgwMDAwMTAwMFVMCS8qIGRvbid0IGdyb3cgYSBjYWNoZSAq
Lw0KIA0KIC8qIGZsYWdzIHRvIHBhc3MgdG8ga21lbV9jYWNoZV9jcmVhdGUo
KS4NCg==
--79888902-1023949917-958157629=:6188--
--
To unsubscribe, send a message with 'unsubscribe linux-mm' in
the body to majordomo@kvack.org.  For more info on Linux MM,
see: http://www.linux.eu.org/Linux-MM/
