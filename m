Return-Path: <owner-linux-mm@kvack.org>
Received: from psmtp.com (na3sys010amx148.postini.com [74.125.245.148])
	by kanga.kvack.org (Postfix) with SMTP id 526A66B0031
	for <linux-mm@kvack.org>; Sat, 14 Sep 2013 07:53:40 -0400 (EDT)
Date: Sat, 14 Sep 2013 19:53:35 +0800 
Reply-To: dhillf@sina.com
From: "Hillf Danton" <dhillf@sina.com>
Subject: [RFC PATCH] mm: numa: adjust hinting fault record if page is migrated
MIME-Version: 1.0
Content-Type: text/plain; charset=GBK
Content-Transfer-Encoding: base64
Message-Id: <20130914115335.3AA33428001@webmail.sinamail.sina.com.cn>
Sender: owner-linux-mm@kvack.org
List-ID: <linux-mm.kvack.org>
To: Mel Gorman <mgorman@suse.de>
Cc: Rik van Riel <riel@redhat.com>, Andrea Arcangeli <aarcange@redhat.com>, linux-kernel <linux-kernel@vger.kernel.org>, linux-mm <linux-mm@kvack.org>, Hillf Danton <dhillf@gmail.com>


QWZ0ZXIgcGFnZSBBIG9uIHNvdXJjZSBub2RlIGlzIG1pZ3JhdGVkIHRvIHBhZ2UgQiBvbiB0YXJn
ZXQgbm9kZSwgaGludGluZw0KZmF1bHQgaXMgcmVjb3JkZWQgb24gdGhlIHRhcmdldCBub2RlIGZv
ciBCLiBPbiB0aGUgc291cmNlIG5vZGUgdGhlcmUgaXMNCmFub3RoZXIgcmVjb3JkIGZvciBBLCBz
aW5jZSBhIHR3by1zdGFnZSBmaWx0ZXIgaXMgdXNlZCB3aGVuIG1pZ3JhdGluZyBwYWdlcy4NCg0K
UGFnZSBBIGlzIG5vIGxvbmdlciB1c2VkIGFmdGVyIG1pZ3JhdGlvbiwgc28gd2UgaGF2ZSB0byBl
cmFzZSBpdHMgcmVjb3JkLg0KDQpTaWduZWQtb2ZmLWJ5OiBIaWxsZiBEYW50b24gPGRoaWxsZkBn
bWFpbC5jb20+DQotLS0NCg0KLS0tIGEvaW5jbHVkZS9saW51eC9zY2hlZC5oCVNhdCBTZXAgMTQg
MTY6NTc6MzIgMjAxMw0KKysrIGIvaW5jbHVkZS9saW51eC9zY2hlZC5oCVNhdCBTZXAgMTQgMTc6
MjI6MjAgMjAxMw0KQEAgLTE0NDAsMTIgKzE0NDAsMTMgQEAgc3RydWN0IHRhc2tfc3RydWN0IHsN
CiAjZGVmaW5lIFRORl9OT19HUk9VUAkweDAyDQogDQogI2lmZGVmIENPTkZJR19OVU1BX0JBTEFO
Q0lORw0KLWV4dGVybiB2b2lkIHRhc2tfbnVtYV9mYXVsdChpbnQgbGFzdF9ub2RlLCBpbnQgbm9k
ZSwgaW50IHBhZ2VzLCBpbnQgZmxhZ3MpOw0KK2V4dGVybiB2b2lkIHRhc2tfbnVtYV9mYXVsdChp
bnQgbGFzdF9jcHVwaWQsIGludCBzcmNfbm9kZSwNCisJCQkJCWludCBkc3Rfbm9kZSwgaW50IHBh
Z2VzLCBpbnQgZmxhZ3MpOw0KIGV4dGVybiBwaWRfdCB0YXNrX251bWFfZ3JvdXBfaWQoc3RydWN0
IHRhc2tfc3RydWN0ICpwKTsNCiBleHRlcm4gdm9pZCBzZXRfbnVtYWJhbGFuY2luZ19zdGF0ZShi
b29sIGVuYWJsZWQpOw0KICNlbHNlDQotc3RhdGljIGlubGluZSB2b2lkIHRhc2tfbnVtYV9mYXVs
dChpbnQgbGFzdF9ub2RlLCBpbnQgbm9kZSwgaW50IHBhZ2VzLA0KLQkJCQkgICBpbnQgZmxhZ3Mp
DQorc3RhdGljIGlubGluZSB2b2lkIHRhc2tfbnVtYV9mYXVsdChpbnQgbGFzdF9jcHVwaWQsIGlu
dCBzcmNfbm9kZSwNCisJCQkJCWludCBkc3Rfbm9kZSwgaW50IHBhZ2VzLCBpbnQgZmxhZ3MpDQog
ew0KIH0NCiBzdGF0aWMgaW5saW5lIHBpZF90IHRhc2tfbnVtYV9ncm91cF9pZChzdHJ1Y3QgdGFz
a19zdHJ1Y3QgKnApDQotLS0gYS9rZXJuZWwvc2NoZWQvZmFpci5jCVdlZCBTZXAgMTEgMTg6MzM6
MDAgMjAxMw0KKysrIGIva2VybmVsL3NjaGVkL2ZhaXIuYwlTYXQgU2VwIDE0IDE3OjU3OjE2IDIw
MTMNCkBAIC0xNDkzLDcgKzE0OTMsOCBAQCB2b2lkIHRhc2tfbnVtYV9mcmVlKHN0cnVjdCB0YXNr
X3N0cnVjdCAqDQogLyoNCiAgKiBHb3QgYSBQUk9UX05PTkUgZmF1bHQgZm9yIGEgcGFnZSBvbiBA
bm9kZS4NCiAgKi8NCi12b2lkIHRhc2tfbnVtYV9mYXVsdChpbnQgbGFzdF9jcHVwaWQsIGludCBu
b2RlLCBpbnQgcGFnZXMsIGludCBmbGFncykNCit2b2lkIHRhc2tfbnVtYV9mYXVsdChpbnQgbGFz
dF9jcHVwaWQsIGludCBzcmNfbm9kZSwgaW50IGRzdF9ub2RlLA0KKwkJCQkJCWludCBwYWdlcywg
aW50IGZsYWdzKQ0KIHsNCiAJc3RydWN0IHRhc2tfc3RydWN0ICpwID0gY3VycmVudDsNCiAJYm9v
bCBtaWdyYXRlZCA9IGZsYWdzICYgVE5GX01JR1JBVEVEOw0KQEAgLTE1NTksNyArMTU2MCwxNSBA
QCB2b2lkIHRhc2tfbnVtYV9mYXVsdChpbnQgbGFzdF9jcHVwaWQsIGluDQogCWlmIChtaWdyYXRl
ZCkNCiAJCXAtPm51bWFfcGFnZXNfbWlncmF0ZWQgKz0gcGFnZXM7DQogDQotCXAtPm51bWFfZmF1
bHRzX2J1ZmZlclt0YXNrX2ZhdWx0c19pZHgobm9kZSwgcHJpdildICs9IHBhZ2VzOw0KKwlwLT5u
dW1hX2ZhdWx0c19idWZmZXJbdGFza19mYXVsdHNfaWR4KGRzdF9ub2RlLCBwcml2KV0gKz0gcGFn
ZXM7DQorDQorCWlmIChtaWdyYXRlZCkgew0KKwkJLyogZXh0cmFjdCBudW1hLWhpbnQgZmF1bHRz
IGZyb20gc3JjIG5vZGUgKi8NCisJCWludCBpZHggPSB0YXNrX2ZhdWx0c19pZHgoc3JjX25vZGUs
IHByaXYpOw0KKw0KKwkJaWYgKHAtPm51bWFfZmF1bHRzW2lkeF0gPj0gcGFnZXMpDQorCQkJcC0+
bnVtYV9mYXVsdHNbaWR4XSAtPSBwYWdlczsNCisJfQ0KIH0NCiANCiBzdGF0aWMgdm9pZCByZXNl
dF9wdGVudW1hX3NjYW4oc3RydWN0IHRhc2tfc3RydWN0ICpwKQ0KLS0tIGEvbW0vaHVnZV9tZW1v
cnkuYwlTYXQgU2VwIDE0IDE2OjU0OjI4IDIwMTMNCisrKyBiL21tL2h1Z2VfbWVtb3J5LmMJU2F0
IFNlcCAxNCAxNzo0Njo1NCAyMDEzDQpAQCAtMTI5NSw2ICsxMjk1LDcgQEAgaW50IGRvX2h1Z2Vf
cG1kX251bWFfcGFnZShzdHJ1Y3QgbW1fc3RydQ0KIAl1bnNpZ25lZCBsb25nIGhhZGRyID0gYWRk
ciAmIEhQQUdFX1BNRF9NQVNLOw0KIAlpbnQgcGFnZV9uaWQgPSAtMSwgdGhpc19uaWQgPSBudW1h
X25vZGVfaWQoKTsNCiAJaW50IHRhcmdldF9uaWQsIGxhc3RfY3B1cGlkID0gLTE7DQorCWludCBz
cmNfbmlkOw0KIAlib29sIHBhZ2VfbG9ja2VkOw0KIAlib29sIG1pZ3JhdGVkID0gZmFsc2U7DQog
CWludCBmbGFncyA9IDA7DQpAQCAtMTMwNiw2ICsxMzA3LDcgQEAgaW50IGRvX2h1Z2VfcG1kX251
bWFfcGFnZShzdHJ1Y3QgbW1fc3RydQ0KIAlwYWdlID0gcG1kX3BhZ2UocG1kKTsNCiAJQlVHX09O
KGlzX2h1Z2VfemVyb19wYWdlKHBhZ2UpKTsNCiAJcGFnZV9uaWQgPSBwYWdlX3RvX25pZChwYWdl
KTsNCisJc3JjX25pZCA9IHBhZ2VfbmlkOw0KIAlsYXN0X2NwdXBpZCA9IHBhZ2VfY3B1cGlkX2xh
c3QocGFnZSk7DQogCWNvdW50X3ZtX251bWFfZXZlbnQoTlVNQV9ISU5UX0ZBVUxUUyk7DQogCWlm
IChwYWdlX25pZCA9PSB0aGlzX25pZCkNCkBAIC0xMzg4LDcgKzEzOTAsNyBAQCBvdXQ6DQogCQlw
YWdlX3VubG9ja19hbm9uX3ZtYV9yZWFkKGFub25fdm1hKTsNCiANCiAJaWYgKHBhZ2VfbmlkICE9
IC0xKQ0KLQkJdGFza19udW1hX2ZhdWx0KGxhc3RfY3B1cGlkLCBwYWdlX25pZCwgSFBBR0VfUE1E
X05SLCBmbGFncyk7DQorCQl0YXNrX251bWFfZmF1bHQobGFzdF9jcHVwaWQsIHNyY19uaWQsIHBh
Z2VfbmlkLCBIUEFHRV9QTURfTlIsIGZsYWdzKTsNCiANCiAJcmV0dXJuIDA7DQogfQ0KLS0tIGEv
bW0vbWVtb3J5LmMJU2F0IFNlcCAxNCAxNjo1NDo1MiAyMDEzDQorKysgYi9tbS9tZW1vcnkuYwlT
YXQgU2VwIDE0IDE3OjUyOjAyIDIwMTMNCkBAIC0zNTU1LDYgKzM1NTUsNyBAQCBpbnQgZG9fbnVt
YV9wYWdlKHN0cnVjdCBtbV9zdHJ1Y3QgKm1tLCBzDQogCXN0cnVjdCBwYWdlICpwYWdlID0gTlVM
TDsNCiAJc3BpbmxvY2tfdCAqcHRsOw0KIAlpbnQgcGFnZV9uaWQgPSAtMTsNCisJaW50IHNyY19u
aWQ7DQogCWludCBsYXN0X2NwdXBpZDsNCiAJaW50IHRhcmdldF9uaWQ7DQogCWJvb2wgbWlncmF0
ZWQgPSBmYWxzZTsNCkBAIC0zNTk3LDYgKzM1OTgsNyBAQCBpbnQgZG9fbnVtYV9wYWdlKHN0cnVj
dCBtbV9zdHJ1Y3QgKm1tLCBzDQogDQogCWxhc3RfY3B1cGlkID0gcGFnZV9jcHVwaWRfbGFzdChw
YWdlKTsNCiAJcGFnZV9uaWQgPSBwYWdlX3RvX25pZChwYWdlKTsNCisJc3JjX25pZCA9IHBhZ2Vf
bmlkOw0KIAl0YXJnZXRfbmlkID0gbnVtYV9taWdyYXRlX3ByZXAocGFnZSwgdm1hLCBhZGRyLCBw
YWdlX25pZCk7DQogCXB0ZV91bm1hcF91bmxvY2socHRlcCwgcHRsKTsNCiAJaWYgKHRhcmdldF9u
aWQgPT0gLTEpIHsNCkBAIC0zNjEzLDcgKzM2MTUsNyBAQCBpbnQgZG9fbnVtYV9wYWdlKHN0cnVj
dCBtbV9zdHJ1Y3QgKm1tLCBzDQogDQogb3V0Og0KIAlpZiAocGFnZV9uaWQgIT0gLTEpDQotCQl0
YXNrX251bWFfZmF1bHQobGFzdF9jcHVwaWQsIHBhZ2VfbmlkLCAxLCBmbGFncyk7DQorCQl0YXNr
X251bWFfZmF1bHQobGFzdF9jcHVwaWQsIHNyY19uaWQsIHBhZ2VfbmlkLCAxLCBmbGFncyk7DQog
CXJldHVybiAwOw0KIH0NCiANCkBAIC0zNjUyLDYgKzM2NTQsNyBAQCBzdGF0aWMgaW50IGRvX3Bt
ZF9udW1hX3BhZ2Uoc3RydWN0IG1tX3N0DQogCQlwdGVfdCBwdGV2YWwgPSAqcHRlOw0KIAkJc3Ry
dWN0IHBhZ2UgKnBhZ2U7DQogCQlpbnQgcGFnZV9uaWQgPSAtMTsNCisJCWludCBzcmNfbmlkOw0K
IAkJaW50IHRhcmdldF9uaWQ7DQogCQlib29sIG1pZ3JhdGVkID0gZmFsc2U7DQogCQlpbnQgZmxh
Z3MgPSAwOw0KQEAgLTM2ODQsNiArMzY4Nyw3IEBAIHN0YXRpYyBpbnQgZG9fcG1kX251bWFfcGFn
ZShzdHJ1Y3QgbW1fc3QNCiANCiAJCWxhc3RfY3B1cGlkID0gcGFnZV9jcHVwaWRfbGFzdChwYWdl
KTsNCiAJCXBhZ2VfbmlkID0gcGFnZV90b19uaWQocGFnZSk7DQorCQlzcmNfbmlkID0gcGFnZV9u
aWQ7DQogCQl0YXJnZXRfbmlkID0gbnVtYV9taWdyYXRlX3ByZXAocGFnZSwgdm1hLCBhZGRyLCBw
YWdlX25pZCk7DQogCQlwdGVfdW5tYXBfdW5sb2NrKHB0ZSwgcHRsKTsNCiAJCWlmICh0YXJnZXRf
bmlkICE9IC0xKSB7DQpAQCAtMzY5Nyw3ICszNzAxLDcgQEAgc3RhdGljIGludCBkb19wbWRfbnVt
YV9wYWdlKHN0cnVjdCBtbV9zdA0KIAkJfQ0KIA0KIAkJaWYgKHBhZ2VfbmlkICE9IC0xKQ0KLQkJ
CXRhc2tfbnVtYV9mYXVsdChsYXN0X2NwdXBpZCwgcGFnZV9uaWQsIDEsIGZsYWdzKTsNCisJCQl0
YXNrX251bWFfZmF1bHQobGFzdF9jcHVwaWQsIHNyY19uaWQsIHBhZ2VfbmlkLCAxLCBmbGFncyk7
DQogDQogCQlwdGUgPSBwdGVfb2Zmc2V0X21hcF9sb2NrKG1tLCBwbWRwLCBhZGRyLCAmcHRsKTsN
CiAJfQ0KLS0=

--
To unsubscribe, send a message with 'unsubscribe linux-mm' in
the body to majordomo@kvack.org.  For more info on Linux MM,
see: http://www.linux-mm.org/ .
Don't email: <a href=mailto:"dont@kvack.org"> email@kvack.org </a>
