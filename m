Return-Path: <owner-linux-mm@kvack.org>
Received: from mail-oi0-f69.google.com (mail-oi0-f69.google.com [209.85.218.69])
	by kanga.kvack.org (Postfix) with ESMTP id ED2456B0038
	for <linux-mm@kvack.org>; Mon, 13 Mar 2017 06:29:55 -0400 (EDT)
Received: by mail-oi0-f69.google.com with SMTP id 62so225482106oih.5
        for <linux-mm@kvack.org>; Mon, 13 Mar 2017 03:29:55 -0700 (PDT)
Received: from EUR01-VE1-obe.outbound.protection.outlook.com (mail-ve1eur01on0126.outbound.protection.outlook.com. [104.47.1.126])
        by mx.google.com with ESMTPS id g18si4424071oic.234.2017.03.13.03.29.54
        for <linux-mm@kvack.org>
        (version=TLS1_2 cipher=ECDHE-RSA-AES128-SHA bits=128/128);
        Mon, 13 Mar 2017 03:29:54 -0700 (PDT)
Subject: Re: strange allocation failures
References: <CACT4Y+ZVWUYda9zr74QOmcXzd0S7P714LhzrVu7wRO0oDM0P2w@mail.gmail.com>
 <d849e961-7120-2ba5-1d58-df81d0ae3293@virtuozzo.com>
 <CACT4Y+Y=Pz6wFN66BGdPkTPJWrnbxCL2GX-R0q5_jr5kwjF+zA@mail.gmail.com>
 <CACT4Y+bD0S9CY0ahvZ=pOpXqHAkH6P0OTHPTeBi-Pb2Nw6ph4w@mail.gmail.com>
From: Andrey Ryabinin <aryabinin@virtuozzo.com>
Message-ID: <cac135d2-7ed4-c066-6316-22be9f7d16a3@virtuozzo.com>
Date: Mon, 13 Mar 2017 13:31:06 +0300
MIME-Version: 1.0
In-Reply-To: <CACT4Y+bD0S9CY0ahvZ=pOpXqHAkH6P0OTHPTeBi-Pb2Nw6ph4w@mail.gmail.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
Sender: owner-linux-mm@kvack.org
List-ID: <linux-mm.kvack.org>
To: Dmitry Vyukov <dvyukov@google.com>
Cc: "Kirill A. Shutemov" <kirill.shutemov@linux.intel.com>, kasan-dev <kasan-dev@googlegroups.com>, "linux-mm@kvack.org" <linux-mm@kvack.org>, Michal Hocko <mhocko@kernel.org>



On 03/13/2017 01:10 PM, Dmitry Vyukov wrote:
> On Mon, Mar 13, 2017 at 11:08 AM, Dmitry Vyukov <dvyukov@google.com> wrote:
>> On Mon, Mar 13, 2017 at 11:04 AM, Andrey Ryabinin
>> <aryabinin@virtuozzo.com> wrote:
>>>
>>>
>>> On 03/13/2017 12:50 PM, Dmitry Vyukov wrote:
>>>> Hello Andrey, Kirill,
>>>>
>>>> Can you please help me understand where is all my memory?
>>>> I am running very moderate workload on a machine with 7.5GB of memory
>>>> with KASAN. And I see constant vmalloc allocation failures for very
>>>> moderate sizes. I am confused why it happens and where is all my
>>>> memory...
>>>>
>>>
>>>
>>> Perhaps it's SIGKILL generated by syzkaller?
>>>
>>> static void *__vmalloc_area_node()
>>> {
>>> .....
>>>                 if (fatal_signal_pending(current)) {
>>>                         area->nr_pages = i;
>>>                         goto fail;
>>>                 }
>>
>>
>> Ah, that would make sense. Syzkaller can indeed kill processes frequently.
>>
>> Perhaps we should not print the lengthy allocation failure message
>> with all the details in such. Not sure how easy it is to filter out
>> such cases.
>> I have constant stream of these messages that just make everything
>> else lost between them. And they are quite confusing. I've starred at
>> the numbers trying to understand why I am short on memory.
> 
> 
> Seems trivial. What do you think of:
> 

Makes sense. ACK.

> diff --git a/mm/vmalloc.c b/mm/vmalloc.c
> index 0dd80222b20b..0b057628a7ba 100644
> --- a/mm/vmalloc.c
> +++ b/mm/vmalloc.c
> @@ -1683,7 +1683,7 @@ static void *__vmalloc_area_node(struct
> vm_struct *area, gfp_t gfp_mask,
> 
>                 if (fatal_signal_pending(current)) {
>                         area->nr_pages = i;
> -                       goto fail;
> +                       goto fail_no_warn;
>                 }
> 
>                 if (node == NUMA_NO_NODE)
> @@ -1709,6 +1709,7 @@ static void *__vmalloc_area_node(struct
> vm_struct *area, gfp_t gfp_mask,
>         warn_alloc(gfp_mask, NULL,
>                           "vmalloc: allocation failure, allocated %ld
> of %ld bytes",
>                           (area->nr_pages*PAGE_SIZE), area->size);
> +fail_no_warn:
>         vfree(area->addr);
>         return NULL;
>  }
> 
> 
> ?
> 

--
To unsubscribe, send a message with 'unsubscribe linux-mm' in
the body to majordomo@kvack.org.  For more info on Linux MM,
see: http://www.linux-mm.org/ .
Don't email: <a href=mailto:"dont@kvack.org"> email@kvack.org </a>
